extends admin
block gallery
    .db-gallery
        .db-gallery-list
            ul
                li.db-new-gallery
                    form.db-new-form(method='post', action='#{url.admin}#{url.adminNewGallery}')
                        input.form-control.album-name(type='text', name='name', placeholder='Album name')
                        textarea.form-control.album-desc(name='desc', placeholder='Album desc')
                        div.album-private
                            span.checkbox
                                i.fa.fa-check-square-o
                                input(type='checkbox', name='private', checked='checked')
                            label(for='flat-checkbox-1')
                                | 私密相册
                        button.album-btn(type='submit') submit
                - albums.forEach(function (item, index) {
                    li.single-album
                        a(href='#{url.admin}#{url.adminGallery}/#{item.name}') 
                            - if (item.cover)
                                span.db-album-cover(style='background-image: url(#{item.cover})')
                            - else
                                span.db-album-cover
                            span.db-album-name
                                - if (item.private)
                                    i.glyphicon.glyphicon-lock
                                | #{item.name} (#{item.count})
                            span.db-album-desc #{item.desc}
                - })


block admin_script
    script.
        $('.album-btn').on('click', function (event) {
            event.preventDefault();

            progress.show('正在创建相册...', function () {
                var name = $('.album-name').val(),
                    desc = $('.album-desc').val(),
                    isPrivate = $('.album-private input').prop('checked');
                $.ajax({
                    type: 'POST',
                    url: '#{url.admin}#{url.adminNewGallery}',
                    data: {
                        name: name,
                        desc: desc,
                        private: isPrivate
                    },
                    success: function (result) {
                        progress.hide(function () {
                            if (result.status === 1) {
                                msg('success', '创建相册成功！', function () {
                                    var wrapper = $('<li>').addClass('single-album'),
                                        link = $('<a>').attr('href', '#{url.admin}#{url.adminGallery}/' + name),
                                        cover = $('<span>').addClass('db-album-cover').css({
                                                'background-image': 'url(/img/default_album.png)'
                                            }),
                                        n = $('<span>').addClass('db-album-name').html(name + ' (0)'),
                                        d = $('<span>').addClass('db-album-desc').html(desc);

                                    wrapper.append(link.append(cover).append(n).append(d));
                                    $('.db-gallery-list ul').append(wrapper);

                                });
                            } else {
                                msg('error', '创建相册失败：' + result.error);
                            }
                        });
                    },
                    error: function (err) {
                        progress.hide(function () {
                            msg('error', err);
                        });
                    }
                });
            });
        });